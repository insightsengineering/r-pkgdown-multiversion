# MultiVersion pkgdown docs action

## Description

Github Action to generate multiple versions of pkgdown docs for R packages.
Additional assumptions:

* As a pre-requisite require R package documentation generated by R function `pkgdown::build_site` (included in example as job `pkgdown`)
* Versioning - release naming convention like `v0.0.1`.
* Tag specific documentation have to be pushed to `gh-pages` subfolder with the `tag` name (step `Unpack release pkgdown to tag dedicated subfolder` in the example below).
* To publish multi-version documentation on Github Pages
  * The `gh-pages` branch have to be checked out before the execution of the`multiversion-docs` step.
  * changed files have to be pushed after this step.

## Action type

Composite

## Quick start

1. Create new action file `.github/workflows/docs-check-with-multisite.yaml` and put example content:

```yaml
---
name: Pkgdown docs with Multi-version site

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
    branches:
      - main

jobs:
  # additional job to create pkgdown documentation for R package 
  # and unpack pkgdown documentation to tag/release specific folders
  # with this same name
  # those 2 are pre-requisites
  pkgdown:
    name: Pkgdown Docs
    runs-on: ubuntu-latest
    container:
      image: rocker/verse:4.1.0
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Checkout test repo
        uses: actions/checkout@v2

      - name: Run r cmd check
        run: |
          R CMD build .
          R CMD INSTALL stageddeps.elecinfra_*.tar.gz

      - name: Build docs
        run: |
          options(repos = c(CRAN = "https://cloud.r-project.org/"))
          if (!require("pkgdown")) install.packages("pkgdown", upgrade = "never")
          library(pkgdown)
          getwd()
          pkgdown::build_site(".", devel = TRUE)
        shell: Rscript {0}

      - name: Create artifacts
        run: |
          pushd ./docs/
          zip -r9 $OLDPWD/pkgdown.zip *
          popd
        shell: bash

      - name: Upload docs for review
        if: github.ref != 'refs/heads/main'
        uses: actions/upload-artifact@v2
        with:
          name: pkgdown.zip
          path: pkgdown.zip

      - name: Setup github user ðŸ‘¤
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"

      - name: Publish pkgdown docs
        # Only after merge or push to main
        if: github.ref == 'refs/heads/main'
        run: |
          Rscript -e 'pkgdown::deploy_to_branch(new_process = FALSE)'
      
      - name: Unpack release pkgdown to tag dedicated subfolder
        # only for release tags 
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          pwd
          mv pkgdown.zip ../pkgdown.zip
          git fetch -a
          git clean -dfx
          git checkout gh-pages
          unzip -o ../pkgdown.zip -d ./${GITHUB_REF_NAME}/
          git add ./${GITHUB_REF_NAME}/
          git commit --message="release documentation ${GITHUB_REF_NAME}"
          git push origin gh-pages
        shell: sh

  # main multi-version related job
  multiversion-docs:
    name: Multi-version docs
    # Only after merge or push to main or started on tags
    if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || startsWith(github.ref, 'refs/tags/v') }} 
    runs-on: ubuntu-latest
    container:
      image: rocker/verse:4.1.0
    needs: 
      - pkgdown
    steps:
      - name: Checkout GH pages branch
        uses: actions/checkout@v2
        with:
          ref: gh-pages

      - name: Build multi-version doc
        uses: insightsengineering/r-pkgdown-multisite@v1
        env:
          GITHUB_PAT: ${{ secrets.REPO_GITHUB_TOKEN }}
          MS_ADD_LINKS_AFTER: "Reference"

      - name: Setup github user ðŸ‘¤
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"

      - name: Push changes, if any
        uses: EndBug/add-and-commit@v7
        with:
          branch: gh-pages


```

## Inputs

* `path`:

    _Description_: Path to package's root

    _Required_: false

    _Default_: "."

* `release_name`:

    _Description_: latest/main, pre-release or new_tag_string (e.g. "v0.8.0") which will be used for R script to change links

    _Required_: true

    _Default_: "main"

## Environments variables

Environment variables that allow to change how the solution works.

* `MS_ADD_LINKS_AFTER`:

    _Description_: Add links to documentation menu as a next to it.
    Additional information:
  * If R package contains file `NEWS.md` than `pkgdown` create two menus _Reference_  and  _Changelog_. This happens most often and that's a reason why value `Changelog` is configured by default.
  * First menu _Reference_ is created by default.

    _Required_: false

    _Default_: "Changelog"

## Links

[R pkgdown package](https://pkgdown.r-lib.org/)

[Git Basics - Tagging](https://git-scm.com/book/en/v2/Git-Basics-Tagging)

[Managing releases in a repository](https://docs.github.com/en/repositories/releasing-projects-on-github/managing-releases-in-a-repository)
